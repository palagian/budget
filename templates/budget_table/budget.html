<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Budget Table</title>
</head>
<body>
    <h1>Budget / FTE Table</h1>
    <div class="scrollable-table-wrapper">
        <table>
            <tr>
                <th class="kam-column">KAM</th>
                <th class="client-column">Client</th>
                <th class="project-column">Project</th>
                <th class="group-column">Group</th>
                {% for month in months %}
                <th class="month">{{ month }}</th>
                {% endfor %}
                <th>Total</th>
            </tr>
            {% for _ in range(60) %}
            <tr>
                <td>
                    <select class="kam-dropdown" data-row="{{ loop.index }}">
                        <option value="" selected>Select KAM</option>
                        {% for kam in kams %}
                        <option value="{{ kam.id }}">{{ kam.name }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <div class="client-wrapper">
                        <select class="client-dropdown" data-row="{{ loop.index }}" data-client-id="">
                            <option value="" selected>Select Client</option>
                        </select>
                        <input type="text" class="client-input" style="display: none;" placeholder="Enter Client Name">
                    </div>
                </td>
                <td>
                    <div class="project-wrapper">
                        <select class="project-dropdown" data-row="{{ loop.index }}">
                            <option value="" selected>Select Project</option>
                        </select>
                        <input type="text" class="project-input" style="display: none;" placeholder="Enter Project Name">
                    </div>
                </td>
                <td>
                    <select class="group-dropdown" data-row="{{ loop.index }}">
                        <option value="" selected>Select Group</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.group }}</option>
                        {% endfor %}
                    </select>
                </td>
                {% for _ in range(12) %}
                <td>
                    <input type="text" class="plan-input" data-client="" data-project="" data-month="{{ loop.index - 3 }}" value="" placeholder="FTE count">
                </td>
                {% endfor %}
                <td class="total-row">0</td>
            </tr>
            {% endfor %}
            <tr>
                <th colspan="4">Total</th>
                {% for _ in range(12) %}
                <td class="total-column">0</td>
                {% endfor %}
                <td class="grand-total">0</td>
            </tr>
        </table>
    </div>

    <script>
         document.addEventListener("DOMContentLoaded", function () {
             function updateTotals() {
                 updateRowTotals();
                 updateColumnTotals();
             }

             function updateRowTotals() {
                 const totalRowCells = document.querySelectorAll(".total-row");
                 totalRowCells.forEach(cell => {
                     const parentRow = cell.parentNode;
                     const planInputs = parentRow.querySelectorAll(".plan-input");
                     let total = 0;
                     planInputs.forEach(input => {
                         const value = parseFloat(input.value);
                         if (!isNaN(value)) {
                             total += value;
                         }
                     });
                     cell.textContent = total.toFixed(1);
                 });
             }

             function updateColumnTotals() {
                 const totalColumnCells = document.querySelectorAll(".total-column");
                 totalColumnCells.forEach((cell, columnIndex) => {
                     const planInputs = document.querySelectorAll(`.plan-input[data-month="${columnIndex - 2}"]`);
                     let total = 0;
                     planInputs.forEach(input => {
                         const value = parseFloat(input.value);
                         if (!isNaN(value)) {
                             total += value;
                         }
                     });
                     cell.textContent = total.toFixed(1);
                 });

                 const grandTotalCell = document.querySelector(".grand-total");
                 let grandTotal = 0;
                 totalColumnCells.forEach(cell => {
                     const total = parseFloat(cell.textContent);
                     if (!isNaN(total)) {
                         grandTotal += total;
                     }
                 });
                 grandTotalCell.textContent = grandTotal.toFixed(1);
             }

             const planInputs = document.querySelectorAll(".plan-input");
             planInputs.forEach(input => {
                 input.addEventListener("change", function () {
                     updateTotals();
                 });
             });

             const kamDropdowns = document.querySelectorAll(".kam-dropdown");
             kamDropdowns.forEach(dropdown => {
                 dropdown.addEventListener("change", function () {
                     const selectedKAM = this.value;
                     const rowNumber = this.getAttribute("data-row");
                     const clientDropdown = document.querySelector(`.client-dropdown[data-row="${rowNumber}"]`);
                     const clientInput = document.querySelector(`.client-input[data-row="${rowNumber}"]`);
                     updateClientDropdownOptions(clientDropdown, clientInput, selectedKAM);
                     updateTotals();
                 });
             });

             const clientDropdowns = document.querySelectorAll(".client-dropdown");
             clientDropdowns.forEach(dropdown => {
                 dropdown.addEventListener("change", function () {
                     const selectedValue = this.value;
                     const clientInput = this.parentNode.querySelector(".client-input");
                     if (selectedValue === "0") {
                         this.style.display = "none";
                         clientInput.style.display = "inline";
                         clientInput.value = "";
                         clientInput.focus();
                     } else {
                         clientInput.style.display = "none";
                         this.style.display = "inline";
                         const projectDropdown = document.querySelector(".project-dropdown");
                         const rowNumber = this.getAttribute("data-row");
                         const selectedClient = selectedValue;
                         console.log(`Selected Client ID: ${selectedClient}`);
                         updateProjectDropdownOptions(projectDropdown, selectedClient);
                     }
                 });
             });


            const projectDropdowns = document.querySelectorAll(".project-dropdown");
            projectDropdowns.forEach(dropdown => {
                dropdown.addEventListener("change", function () {
                    const selectedValue = this.value;
                    const projectInput = this.parentNode.querySelector(".project-input");
                    if (selectedValue === "0") {
                        this.style.display = "none";
                        projectInput.style.display = "inline";
                        projectInput.value = "";
                        projectInput.focus();
                    } else {
                        projectInput.style.display = "none";
                        this.style.display = "inline";
                    }
                });
            });



             function updateClientDropdownOptions(clientDropdown, clientInput, selectedKAM) {
                 fetch(`/get_clients_for_kam/${selectedKAM}`)
                     .then(response => response.json())
                     .then(data => {
                         clientDropdown.innerHTML = '<option value="" selected>Select Client</option>';
                         data.forEach(option => {
                             const optionElement = document.createElement('option');
                             optionElement.value = option.id;
                             optionElement.textContent = option.name;
                             clientDropdown.appendChild(optionElement);
                         });
                         const otherClientOption = document.createElement('option');
                         otherClientOption.value = '0';
                         otherClientOption.textContent = 'Other Client';
                         clientDropdown.appendChild(otherClientOption);
                     })
                     .catch(error => {
                         console.error('Error fetching clients:', error);
                     });
             }

             function updateProjectDropdownOptions(projectDropdown, selectedClient) {
                 const url = `/get_projects_for_client/${selectedClient}`;
                 console.log(`Request URL: ${url}`);

                 if (projectDropdown) {
                 fetch(url)
                     .then(response => {
                         if (!response.ok) {
                             throw new Error(`Network response was not ok: ${response.status}`);
                         }
                         return response.json();
                     })
                     .then(data => {
                         console.log(data);
                         projectDropdown.innerHTML = '<option value="" selected>Select Project</option>';
                         data.forEach(option => {
                             const optionElement = document.createElement('option');
                             optionElement.value = option.id;
                             optionElement.textContent = option.name;
                             projectDropdown.appendChild(optionElement);

                             console.log(optionElement.value);
                             console.log(optionElement.textContent);
                         });
                         const otherProjectOption = document.createElement('option');
                         otherProjectOption.value = '0';
                         otherProjectOption.textContent = 'Other Project';
                         projectDropdown.appendChild(otherProjectOption);
                     })
                     .catch(error => {
                         console.error('Error fetching projects:', error);
                     });
                } else {
                     console.error("projectDropdown не ініціалізовано або має значення null.");
                 }
             }



             // Call the updateTotals function when the page loads to initialize the totals
             updateTotals();
         });
    </script>
</body>
</html>